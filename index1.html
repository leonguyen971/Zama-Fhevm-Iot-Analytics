<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHEVM IoT Security Analytics Demo</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Smart Contract Component
        const SmartContract = ({ onContractUpdate }) => {
            const [contractCode, setContractCode] = useState(`// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "fhevm/lib/TFHE.sol";

contract IoTSecurityAnalytics {
    struct EncryptedData {
        euint32 temperature;
        euint32 humidity;
        euint32 pressure;
        uint256 timestamp;
        address device;
    }
    
    mapping(address => EncryptedData[]) private deviceData;
    mapping(address => euint32) private anomalyScores;
    
    event AnomalyDetected(address device, uint256 timestamp);
    
    function submitData(
        bytes calldata encTemp,
        bytes calldata encHum, 
        bytes calldata encPres
    ) external {
        euint32 temp = TFHE.asEuint32(encTemp);
        euint32 hum = TFHE.asEuint32(encHum);
        euint32 pres = TFHE.asEuint32(encPres);
        
        deviceData[msg.sender].push(EncryptedData({
            temperature: temp,
            humidity: hum,
            pressure: pres,
            timestamp: block.timestamp,
            device: msg.sender
        }));
        
        _analyzeAnomaly(msg.sender, temp, hum, pres);
    }
    
    function _analyzeAnomaly(
        address device,
        euint32 temp,
        euint32 hum,
        euint32 pres
    ) private {
        // Phân tích bất thường trên dữ liệu mã hóa
        euint32 tempThreshold = TFHE.asEuint32(50);
        euint32 humThreshold = TFHE.asEuint32(80);
        
        ebool tempAnomaly = TFHE.gt(temp, tempThreshold);
        ebool humAnomaly = TFHE.gt(hum, humThreshold);
        
        euint32 score = TFHE.select(tempAnomaly, 
            TFHE.asEuint32(100), TFHE.asEuint32(0));
        score = TFHE.add(score, 
            TFHE.select(humAnomaly, TFHE.asEuint32(50), TFHE.asEuint32(0)));
            
        anomalyScores[device] = score;
        
        // Emit event nếu phát hiện bất thường
        if (TFHE.decrypt(TFHE.gt(score, TFHE.asEuint32(75)))) {
            emit AnomalyDetected(device, block.timestamp);
        }
    }
}`);

            const [deployScript, setDeployScript] = useState(`// deploy.js
const { ethers } = require("hardhat");
const { FhevmInstance } = require("fhevmjs");

async function main() {
    console.log("🚀 Deploying IoT Security Analytics Contract...");
    
    const [deployer] = await ethers.getSigners();
    console.log("Deploying with account:", deployer.address);
    
    // Deploy contract
    const IoTAnalytics = await ethers.getContractFactory("IoTSecurityAnalytics");
    const contract = await IoTAnalytics.deploy();
    await contract.deployed();
    
    console.log("✅ Contract deployed to:", contract.address);
    
    // Initialize FHEVM instance
    const instance = await FhevmInstance.create({
        chainId: 8009, // Zama devnet
        networkUrl: "https://devnet.zama.ai/",
        gatewayUrl: "https://gateway.zama.ai/"
    });
    
    console.log("🔐 FHEVM instance initialized");
    
    return {
        contractAddress: contract.address,
        instance: instance
    };
}

main()
    .then(() => process.exit(0))
    .catch((error) => {
        console.error(error);
        process.exit(1);
    });`);

            useEffect(() => {
                onContractUpdate({ contractCode, deployScript });
            }, [contractCode, deployScript]);

            return (
                <div className="bg-gray-800 rounded-lg p-6 shadow-xl">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center">
                        <i className="fas fa-file-contract mr-2 text-blue-400"></i>
                        Smart Contract & Deploy Script
                    </h3>
                    
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-300 mb-2">
                                Smart Contract (Solidity)
                            </label>
                            <textarea
                                value={contractCode}
                                onChange={(e) => setContractCode(e.target.value)}
                                className="w-full h-64 bg-gray-900 text-green-400 font-mono text-sm p-4 rounded border border-gray-600 focus:border-blue-500 focus:outline-none"
                                style={{ fontFamily: 'Monaco, Consolas, monospace' }}
                            />
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-gray-300 mb-2">
                                Deploy Script (JavaScript)
                            </label>
                            <textarea
                                value={deployScript}
                                onChange={(e) => setDeployScript(e.target.value)}
                                className="w-full h-48 bg-gray-900 text-yellow-400 font-mono text-sm p-4 rounded border border-gray-600 focus:border-blue-500 focus:outline-none"
                                style={{ fontFamily: 'Monaco, Consolas, monospace' }}
                            />
                        </div>
                    </div>
                </div>
            );
        };

        // IoT Device Simulator Component
        const IoTDeviceSimulator = ({ onDataGenerated, onAutoGenerate }) => {
            const [devices, setDevices] = useState([
                { 
                    id: 'device_001', 
                    name: 'Temperature Sensor A', 
                    status: 'active', 
                    location: 'Server Room',
                    currentValues: { temperature: 25, humidity: 45, pressure: 1013 }
                },
                { 
                    id: 'device_002', 
                    name: 'Humidity Monitor B', 
                    status: 'active', 
                    location: 'Data Center',
                    currentValues: { temperature: 22, humidity: 55, pressure: 1015 }
                },
                { 
                    id: 'device_003', 
                    name: 'Pressure Gauge C', 
                    status: 'warning', 
                    location: 'HVAC System',
                    currentValues: { temperature: 28, humidity: 65, pressure: 1018 }
                }
            ]);
            
            const [isGenerating, setIsGenerating] = useState(false);
            const [countdown, setCountdown] = useState(10);

            // Simulate real-time data updates with stronger fluctuations
            useEffect(() => {
                const interval = setInterval(() => {
                    setDevices(prev => prev.map(device => ({
                        ...device,
                        currentValues: {
                            temperature: Math.max(10, Math.min(70, device.currentValues.temperature + (Math.random() - 0.5) * 8)),
                            humidity: Math.max(10, Math.min(100, device.currentValues.humidity + (Math.random() - 0.5) * 12)),
                            pressure: Math.max(980, Math.min(1060, device.currentValues.pressure + (Math.random() - 0.5) * 6))
                        }
                    })));
                }, 2000);

                return () => clearInterval(interval);
            }, []);

            // Auto-generate every 10 seconds
            useEffect(() => {
                const autoInterval = setInterval(() => {
                    setCountdown(prev => {
                        if (prev <= 1) {
                            onAutoGenerate();
                            return 10;
                        }
                        return prev - 1;
                    });
                }, 1000);

                return () => clearInterval(autoInterval);
            }, [onAutoGenerate]);

            const generateEncryptedData = () => {
                setIsGenerating(true);
                
                const newData = devices.map(device => ({
                    deviceId: device.id,
                    deviceName: device.name,
                    encryptedTemp: `0x${Math.random().toString(16).substr(2, 64)}`,
                    encryptedHumidity: `0x${Math.random().toString(16).substr(2, 64)}`,
                    encryptedPressure: `0x${Math.random().toString(16).substr(2, 64)}`,
                    timestamp: new Date().toISOString(),
                    rawValues: {
                        temperature: device.currentValues.temperature + (Math.random() - 0.5) * 4, // Slight variation from current
                        humidity: device.currentValues.humidity + (Math.random() - 0.5) * 6,
                        pressure: device.currentValues.pressure + (Math.random() - 0.5) * 3
                    }
                }));
                
                setTimeout(() => {
                    onDataGenerated(newData, true); // Pass reset flag
                    setIsGenerating(false);
                }, 1500);
            };

            return (
                <div className="bg-gray-800 rounded-lg p-6 shadow-xl">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center">
                        <i className="fas fa-microchip mr-2 text-green-400"></i>
                        IoT Device Simulator
                    </h3>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        {devices.map(device => (
                            <div key={device.id} className="bg-gray-700 rounded-lg p-4">
                                <div className="flex items-center justify-between mb-3">
                                    <h4 className="font-semibold text-white">{device.name}</h4>
                                    <span className={`px-2 py-1 rounded-full text-xs ${
                                        device.status === 'active' ? 'bg-green-500 text-white' : 'bg-yellow-500 text-black'
                                    }`}>
                                        {device.status}
                                    </span>
                                </div>
                                <p className="text-gray-300 text-sm mb-3">{device.location}</p>
                                
                                {/* Real-time sensor values */}
                                <div className="space-y-2 mb-3">
                                    <div className="flex items-center justify-between">
                                        <span className="text-gray-400 text-xs flex items-center">
                                            <i className="fas fa-thermometer-half mr-1 text-red-400"></i>
                                            Temperature
                                        </span>
                                        <span className="text-white font-mono text-sm">
                                            {device.currentValues.temperature.toFixed(1)}°C
                                        </span>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <span className="text-gray-400 text-xs flex items-center">
                                            <i className="fas fa-tint mr-1 text-blue-400"></i>
                                            Humidity
                                        </span>
                                        <span className="text-white font-mono text-sm">
                                            {device.currentValues.humidity.toFixed(1)}%
                                        </span>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <span className="text-gray-400 text-xs flex items-center">
                                            <i className="fas fa-gauge mr-1 text-purple-400"></i>
                                            Pressure
                                        </span>
                                        <span className="text-white font-mono text-sm">
                                            {device.currentValues.pressure.toFixed(0)} hPa
                                        </span>
                                    </div>
                                </div>
                                
                                <div className="pt-2 border-t border-gray-600">
                                    <p className="text-gray-400 text-xs">ID: {device.id}</p>
                                    <div className="flex items-center mt-1">
                                        <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse mr-2"></div>
                                        <span className="text-gray-400 text-xs">Live Data</span>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div className="space-y-3">
                        <div className="bg-gray-600 rounded-lg p-3 text-center">
                            <p className="text-gray-300 text-sm mb-1">Auto-generate in:</p>
                            <p className="text-white font-bold text-xl">{countdown}s</p>
                        </div>
                        
                        <button
                            onClick={generateEncryptedData}
                            disabled={isGenerating}
                            className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center"
                        >
                            {isGenerating ? (
                                <>
                                    <i className="fas fa-spinner fa-spin mr-2"></i>
                                    Generating Encrypted Data...
                                </>
                            ) : (
                                <>
                                    <i className="fas fa-shield-alt mr-2"></i>
                                    Generate Encrypted IoT Data
                                </>
                            )}
                        </button>
                    </div>
                </div>
            );
        };

        // Data Analytics Component
        const DataAnalytics = ({ encryptedData, onAnomalyDetected }) => {
            const [analysisResults, setAnalysisResults] = useState([]);
            const [isAnalyzing, setIsAnalyzing] = useState(false);

            useEffect(() => {
                if (encryptedData.length > 0) {
                    // Reset analysis results when new data comes in
                    setAnalysisResults([]);
                    analyzeData();
                } else {
                    setAnalysisResults([]);
                }
            }, [encryptedData]);

            const analyzeData = () => {
                setIsAnalyzing(true);
                
                setTimeout(() => {
                    const results = encryptedData.map(data => {
                        const { temperature, humidity, pressure } = data.rawValues;
                        
                        // Simulate FHEVM analysis on encrypted data
                        let anomalyScore = 0;
                        let anomalies = [];
                        
                        if (temperature > 45) {
                            anomalyScore += 40;
                            anomalies.push('High Temperature');
                        }
                        if (humidity > 80) {
                            anomalyScore += 30;
                            anomalies.push('High Humidity');
                        }
                        if (pressure > 1040 || pressure < 1010) {
                            anomalyScore += 20;
                            anomalies.push('Pressure Anomaly');
                        }
                        
                        const riskLevel = anomalyScore > 50 ? 'high' : anomalyScore > 25 ? 'medium' : 'low';
                        
                        return {
                            ...data,
                            anomalyScore,
                            anomalies,
                            riskLevel,
                            analysisTime: new Date().toISOString()
                        };
                    });
                    
                    setAnalysisResults(results);
                    setIsAnalyzing(false);
                    
                    const highRiskDevices = results.filter(r => r.riskLevel === 'high');
                    if (highRiskDevices.length > 0) {
                        onAnomalyDetected(highRiskDevices);
                    }
                }, 2000);
            };

            return (
                <div className="bg-gray-800 rounded-lg p-6 shadow-xl">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center">
                        <i className="fas fa-chart-line mr-2 text-purple-400"></i>
                        FHEVM Analytics Results
                    </h3>
                    
                    {isAnalyzing ? (
                        <div className="text-center py-8">
                            <i className="fas fa-cog fa-spin text-4xl text-blue-400 mb-4"></i>
                            <p className="text-white">Analyzing encrypted data with FHEVM...</p>
                            <p className="text-gray-400 text-sm mt-2">Processing homomorphic computations</p>
                        </div>
                    ) : analysisResults.length > 0 ? (
                        <div className="space-y-4">
                            {analysisResults.map((result, index) => (
                                <div key={index} className="bg-gray-700 rounded-lg p-4">
                                    <div className="flex items-center justify-between mb-3">
                                        <h4 className="font-semibold text-white">{result.deviceName}</h4>
                                        <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                                            result.riskLevel === 'high' ? 'bg-red-500 text-white' :
                                            result.riskLevel === 'medium' ? 'bg-yellow-500 text-black' :
                                            'bg-green-500 text-white'
                                        }`}>
                                            {result.riskLevel.toUpperCase()} RISK
                                        </span>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4 mb-3">
                                        <div>
                                            <p className="text-gray-300 text-sm">Anomaly Score</p>
                                            <p className="text-white font-bold text-lg">{result.anomalyScore}/100</p>
                                        </div>
                                        <div>
                                            <p className="text-gray-300 text-sm">Detected Issues</p>
                                            <p className="text-white">{result.anomalies.length || 'None'}</p>
                                        </div>
                                    </div>
                                    
                                    {result.anomalies.length > 0 && (
                                        <div className="mb-3">
                                            <p className="text-gray-300 text-sm mb-1">Anomalies:</p>
                                            <div className="flex flex-wrap gap-2">
                                                {result.anomalies.map((anomaly, i) => (
                                                    <span key={i} className="bg-red-600 text-white px-2 py-1 rounded text-xs">
                                                        {anomaly}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="text-xs text-gray-400">
                                        <p>Device: {result.deviceId}</p>
                                        <p>Analysis: {new Date(result.analysisTime).toLocaleString('vi-VN')}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="text-center py-8 text-gray-400">
                            <i className="fas fa-database text-4xl mb-4"></i>
                            <p>No data to analyze yet</p>
                            <p className="text-sm">Generate IoT data to see analytics results</p>
                        </div>
                    )}
                </div>
            );
        };

        // Encrypted Data Display Component
        const EncryptedDataDisplay = ({ data }) => {
            return (
                <div className="bg-gray-800 rounded-lg p-6 shadow-xl">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center">
                        <i className="fas fa-lock mr-2 text-yellow-400"></i>
                        Encrypted Data Stream
                    </h3>
                    
                    {data.length > 0 ? (
                        <div className="space-y-4 max-h-96 overflow-y-auto">
                            {data.map((item, index) => (
                                <div key={index} className="bg-gray-700 rounded-lg p-4">
                                    <div className="flex items-center justify-between mb-2">
                                        <h4 className="font-semibold text-white">{item.deviceName}</h4>
                                        <span className="text-xs text-gray-400">
                                            {new Date(item.timestamp).toLocaleString('vi-VN')}
                                        </span>
                                    </div>
                                    
                                    <div className="space-y-2 text-sm">
                                        <div>
                                            <span className="text-gray-300">Encrypted Temperature:</span>
                                            <p className="text-green-400 font-mono break-all">{item.encryptedTemp}</p>
                                        </div>
                                        <div>
                                            <span className="text-gray-300">Encrypted Humidity:</span>
                                            <p className="text-blue-400 font-mono break-all">{item.encryptedHumidity}</p>
                                        </div>
                                        <div>
                                            <span className="text-gray-300">Encrypted Pressure:</span>
                                            <p className="text-purple-400 font-mono break-all">{item.encryptedPressure}</p>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-3 pt-3 border-t border-gray-600">
                                        <p className="text-xs text-gray-400">
                                            🔐 Data được mã hóa bằng FHEVM - có thể xử lý mà không giải mã
                                        </p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="text-center py-8 text-gray-400">
                            <i className="fas fa-stream text-4xl mb-4"></i>
                            <p>No encrypted data received</p>
                            <p className="text-sm">Waiting for IoT devices to send data...</p>
                        </div>
                    )}
                </div>
            );
        };

        // Alert System Component
        const AlertSystem = ({ alerts }) => {
            return (
                <div className="bg-gray-800 rounded-lg p-6 shadow-xl">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center">
                        <i className="fas fa-exclamation-triangle mr-2 text-red-400"></i>
                        Current Security Alerts
                    </h3>
                    
                    {alerts.length > 0 ? (
                        <div className="space-y-3">
                            {alerts.map((alert, index) => (
                                <div key={index} className="bg-red-900 border border-red-600 rounded-lg p-4">
                                    <div className="flex items-center justify-between mb-2">
                                        <h4 className="font-semibold text-red-100">{alert.deviceName}</h4>
                                        <span className="bg-red-600 text-white px-2 py-1 rounded text-xs">
                                            CRITICAL
                                        </span>
                                    </div>
                                    <p className="text-red-200 text-sm mb-2">
                                        Anomaly Score: {alert.anomalyScore}/100
                                    </p>
                                    <div className="flex flex-wrap gap-1">
                                        {alert.anomalies.map((anomaly, i) => (
                                            <span key={i} className="bg-red-700 text-red-100 px-2 py-1 rounded text-xs">
                                                {anomaly}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="text-center py-6 text-gray-400">
                            <i className="fas fa-shield-alt text-3xl mb-3"></i>
                            <p>All systems normal</p>
                            <p className="text-sm">No security alerts detected</p>
                        </div>
                    )}
                </div>
            );
        };

        // Error History Table Component
        const ErrorHistoryTable = ({ errorHistory }) => {
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 6;
            const totalPages = Math.ceil(errorHistory.length / itemsPerPage);
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentItems = errorHistory.slice(startIndex, endIndex);

            return (
                <div className="bg-gray-800 rounded-lg p-6 shadow-xl">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center">
                        <i className="fas fa-history mr-2 text-orange-400"></i>
                        Error History ({errorHistory.length} total)
                    </h3>
                    
                    {errorHistory.length > 0 ? (
                        <>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead>
                                        <tr className="border-b border-gray-600">
                                            <th className="text-left text-gray-300 py-2 px-3">Time</th>
                                            <th className="text-left text-gray-300 py-2 px-3">Device</th>
                                            <th className="text-left text-gray-300 py-2 px-3">Score</th>
                                            <th className="text-left text-gray-300 py-2 px-3">Errors</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {currentItems.map((error, index) => (
                                            <tr key={startIndex + index} className="border-b border-gray-700 hover:bg-gray-700">
                                                <td className="py-3 px-3 text-gray-300">
                                                    {new Date(error.timestamp).toLocaleString('vi-VN')}
                                                </td>
                                                <td className="py-3 px-3 text-white font-medium">
                                                    {error.deviceName}
                                                </td>
                                                <td className="py-3 px-3">
                                                    <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                        error.anomalyScore > 70 ? 'bg-red-600 text-white' :
                                                        error.anomalyScore > 50 ? 'bg-orange-600 text-white' :
                                                        'bg-yellow-600 text-black'
                                                    }`}>
                                                        {error.anomalyScore}/100
                                                    </span>
                                                </td>
                                                <td className="py-3 px-3">
                                                    <div className="flex flex-wrap gap-1">
                                                        {error.anomalies.map((anomaly, i) => (
                                                            <span key={i} className="bg-red-600 text-white px-1 py-0.5 rounded text-xs">
                                                                {anomaly}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            
                            {totalPages > 1 && (
                                <div className="flex justify-between items-center mt-4">
                                    <p className="text-gray-400 text-sm">
                                        Showing {startIndex + 1}-{Math.min(endIndex, errorHistory.length)} of {errorHistory.length}
                                    </p>
                                    <div className="flex space-x-2">
                                        <button
                                            onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                                            disabled={currentPage === 1}
                                            className="px-3 py-1 bg-gray-600 hover:bg-gray-500 disabled:bg-gray-700 text-white rounded text-sm"
                                        >
                                            Previous
                                        </button>
                                        <span className="px-3 py-1 bg-blue-600 text-white rounded text-sm">
                                            {currentPage} / {totalPages}
                                        </span>
                                        <button
                                            onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                                            disabled={currentPage === totalPages}
                                            className="px-3 py-1 bg-gray-600 hover:bg-gray-500 disabled:bg-gray-700 text-white rounded text-sm"
                                        >
                                            Next
                                        </button>
                                    </div>
                                </div>
                            )}
                        </>
                    ) : (
                        <div className="text-center py-8 text-gray-400">
                            <i className="fas fa-clipboard-list text-4xl mb-4"></i>
                            <p>No error history yet</p>
                            <p className="text-sm">Errors will be logged here automatically</p>
                        </div>
                    )}
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [encryptedData, setEncryptedData] = useState([]);
            const [alerts, setAlerts] = useState([]);
            const [errorHistory, setErrorHistory] = useState([]);
            const [contractInfo, setContractInfo] = useState({});

            const handleDataGenerated = (newData, shouldReset = false) => {
                if (shouldReset) {
                    // Reset all data when generating new batch
                    setEncryptedData(newData);
                    setAlerts([]);
                } else {
                    setEncryptedData(prev => [...newData, ...prev].slice(0, 10)); // Keep last 10 entries
                }
            };

            const handleAnomalyDetected = (anomalies) => {
                setAlerts(prev => [...anomalies, ...prev].slice(0, 5)); // Keep last 5 alerts
                
                // Add errors to history
                const newErrors = anomalies.map(anomaly => ({
                    ...anomaly,
                    timestamp: new Date().toISOString(),
                    id: Date.now() + Math.random()
                }));
                
                setErrorHistory(prev => [...newErrors, ...prev]);
            };

            const handleContractUpdate = (info) => {
                setContractInfo(info);
            };

            const handleAutoGenerate = () => {
                // Auto-generate data with current device values
                const simulatedDevices = [
                    { id: 'device_001', name: 'Temperature Sensor A' },
                    { id: 'device_002', name: 'Humidity Monitor B' },
                    { id: 'device_003', name: 'Pressure Gauge C' }
                ];
                
                const newData = simulatedDevices.map(device => ({
                    deviceId: device.id,
                    deviceName: device.name,
                    encryptedTemp: `0x${Math.random().toString(16).substr(2, 64)}`,
                    encryptedHumidity: `0x${Math.random().toString(16).substr(2, 64)}`,
                    encryptedPressure: `0x${Math.random().toString(16).substr(2, 64)}`,
                    timestamp: new Date().toISOString(),
                    rawValues: {
                        temperature: Math.floor(Math.random() * 60) + 10, // 10-70°C
                        humidity: Math.floor(Math.random() * 90) + 10,    // 10-100%
                        pressure: Math.floor(Math.random() * 80) + 980    // 980-1060 hPa
                    }
                }));
                
                handleDataGenerated(newData, true);
            };

            return (
                <div className="min-h-screen p-6">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold text-white mb-2">
                                🔐 FHEVM IoT Security Analytics
                            </h1>
                            <p className="text-gray-300 text-lg">
                                Phân tích dữ liệu IoT bảo mật với Fully Homomorphic Encryption
                            </p>
                            <div className="flex justify-center items-center mt-4 space-x-6 text-sm text-gray-400">
                                <span className="flex items-center">
                                    <i className="fas fa-shield-alt mr-1 text-green-400"></i>
                                    End-to-End Encryption
                                </span>
                                <span className="flex items-center">
                                    <i className="fas fa-microchip mr-1 text-blue-400"></i>
                                    Real-time Processing
                                </span>
                                <span className="flex items-center">
                                    <i className="fas fa-chart-line mr-1 text-purple-400"></i>
                                    Anomaly Detection
                                </span>
                            </div>
                        </div>

                        {/* Main Grid */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <IoTDeviceSimulator 
                                onDataGenerated={handleDataGenerated} 
                                onAutoGenerate={handleAutoGenerate}
                            />
                            <AlertSystem alerts={alerts} />
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <EncryptedDataDisplay data={encryptedData} />
                            <DataAnalytics 
                                encryptedData={encryptedData} 
                                onAnomalyDetected={handleAnomalyDetected} 
                            />
                        </div>

                        {/* Error History Table */}
                        <div className="mb-6">
                            <ErrorHistoryTable errorHistory={errorHistory} />
                        </div>

                        {/* Smart Contract Section */}
                        <SmartContract onContractUpdate={handleContractUpdate} />

                        {/* Footer */}
                        <div className="mt-8 text-center text-gray-400 text-sm">
                            <p>🚀 Demo FHEVM IoT Analytics - Dữ liệu được xử lý mà không cần giải mã</p>
                            <p className="mt-1">Powered by Zama FHEVM & React Components</p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96e653e2129709d4',t:'MTc1NTA2ODM0NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
